<!DOCTYPE html>

<!--
*********************************************************************
 * SAPT-Toolkit Progress Calculator
 * 
 * ¬© 2025 SVPA-ASMAP-ASAP (Swiss Association of Psychiatric Trainees)
 *
 * This code is proprietary and intended exclusively for use by the
 * association and its members. Redistribution, commercial use,
 * or modification is not permitted without explicit authorization.
 *
 * This tool is provided "as is", without warranty of any kind.
 * It is based on the interpretation of ISFM-FMH official training
 * programs. The association and its members do not accept any
 * liability for errors or omissions in the calculations.
 * Always consult the official ISFM-FMH documents for reference.
 *
 * Key Features:
 *  - Multi-language support (DE/FR/IT)
 *  - Dynamic calculation of training periods and credits
 *  - Visual summary of training progress
 *  - Modern UI for clarity and usability
 *
 * For feedback or permission requests, contact info@svpa-asmap.ch
 *********************************************************************
-->

<html lang="de">

  <head>
    <meta charset="UTF-8">
    <title id="pageTitle"></title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <style>
      body {
        font-family: Montserrat,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: auto;
        background: linear-gradient(to bottom, #e3d9f8 0%, #ede7fa 100%);
        position: relative;
      }

      #pdfExportBox {
        padding: 44px 38px 48px 38px;
        min-height: 900px;
        min-width: 700px;
        background: linear-gradient(135deg, #e3d9f8 0%, #ede7fa 100%);
        border-radius: 32px;
        box-shadow: 0 4px 28px rgba(60,40,90,0.10);
        color: #352682;
        font-family: Montserrat,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      }
    

      #topBar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px 12px 18px;
        background: transparent;
        position: relative;
        flex-wrap: nowrap;
        gap: 0;
      }

      #logo {
        max-height: 120px;
        width: auto;
        height: auto;
        display: block;
      }

      .lang-switcher {
        background-color: #007bff;
        color: white;
        border-radius: 8px;
        padding: 8px 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1em;
        cursor: pointer;
        user-select: none;
        position: relative;
        min-width: 90px;
        box-shadow: 0 2px 6px rgba(70,40,90,0.06);
        transition: background .18s;
      }

      .lang-switcher:hover { background-color: #0056b3; }
      .lang-switcher span { pointer-events: none; }
      .lang-switcher::before { content: 'üåê'; margin-right: 7px; }
      .lang-switcher::after {
        content: '';
        margin-left: 7px;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 5px solid white;
      }
      
      select#languageSwitcher {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        cursor: pointer;
      }

      h1 {
        color: #352682;
        font-weight: bold;
        text-align: center;
      }
      
      h2 {
        color: #352682;
        text-align: center;
      }

      .section, .periodo {
        background: #fff;
        border: 1px solid #dad4f3;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(80,60,120,0.07);
        padding: 15px;
        margin-bottom: 20px;
      }

      .periodo {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
        align-items: flex-start;
        position: relative;
      }
      
      .periodo label {
        display: flex;
        align-items: center;
        margin: 8px 0;
        gap: 10px;
        flex: 1 1 200px;
        min-width: 120px;
      }
      
      .categoria-label { display: none }

      select, input, datalist {
        flex-grow: 1;
        padding: 5px;
        border-radius: 6px;
        border: 1px solid #ccc;
        min-width: 0;
        font-size: 1em;
      }
    
      input.error {
      border: 2px solid #dc3545;
      }

      button, .lang-switcher {
        background: #007bff;
        color: #fff;
        border-radius: 8px;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 10px;
      }
      
      button:hover, .lang-switcher:hover {
        background: #0056b3;
      }
      .centered-button { text-align: center }

      .small-title { font-size: 1em; margin: 10px 0 }

      .checkbox-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px
      }

      .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-start;
        text-align: left;
      }

      .checkbox-group input[type="checkbox"] {
        /* Prevent stretched checkboxes */
        flex-grow: 0;
        width: auto;
      }

      .remove-period-btn {
        position: absolute;
        top: -18px;  
        right: -18px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        padding: 0;
        width: 38px;
        height: 38px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1em;
        z-index: 2;
        box-shadow: 0 2px 10px rgba(80,40,60,0.10);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background .2s;
      }

      .modern-divider {
        width: 60%;
        height: 2.5px;
        margin: 34px auto 34px auto;
        background: #352682 80%;
        border-radius: 3px;
        opacity: 0.46;
      }

    
      .remove-period-btn:hover { background: #b02a37; }


      #clearButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-size: 1.2em;
      }

      #clearButton:hover { background-color: #b02a37; }

      @media (max-width: 800px) {
        #topBar { padding: 10px 7px 7px 7px; }
        #logo { max-width: 120px; }
        .lang-switcher { min-width: 70px; font-size: 0.95em; padding: 8px 14px;}
      }
    
      @media (max-width: 450px) {
        #logo { max-width: 72px; }
        #topBar { padding: 5px 2px 2px 2px;}
        .lang-switcher { font-size: 0.9em; padding: 8px 7px;}
      }
    
      .errore-periodo {
        border: 2.5px solid #e63946 !important;
        background-color: #fff0f0 !important;
      }

      .errore-select {
        border: 2px solid #e63946 !important;
        background: #fff0f0 !important;
      }

      .error-message {
        color: #e63946;
        font-weight: bold;
        text-align: center;
        margin-bottom: 18px;
        font-size: 1.07em;
        }


      .offscreen {
        position: absolute !important;
        left: -9999px !important;
        top: 0 !important;
      }
    
    </style>
  </head>

  <body>

    <div id="topBar">
      <img src="https://svpa-asmap.ch/wp-content/uploads/2024/01/logo-2.png" id="logo" alt="Logo SVPA-ASMAP-ASAP">
      <div class="lang-switcher">
        <span id="selected-lang">IT</span>
        <select id="languageSwitcher">
          <option value="de">DE</option>
          <option value="fr">FR</option>
          <option value="it">IT</option>
        </select>
      </div>
    </div>


    <div id="headerContainer">
      <h1 id="headerTitle"></h1>
      <h2 id="headerSubtitle" style="margin-top:-10px;"></h2>
    </div>

    <p id="disclaimer" style="text-align:center; font-size:0.9em; color:#666; max-width: 700px; margin: 10px auto 20px;"></p>

    <br><br>

    <h2 id="workTitle"></h2>

    <div id="periodi"></div>
    <div class="centered-button">
      <button id="addPeriodBtn"></button>
    </div>
    <br>

    <div id="DomcambioCentro" class="section" style="display:none;">
      <label for="gerntoPsy"><span id="labelGerontoPsy"></span>
        <select id="gerontoPsy">
          <option value="" disabled selected hidden></option>
          <option value="yes"></option>
          <option value="no"></option>
        </select>
      </label>
      <br><br>
      <label for="cambioCentro"><span id="labelCambioCentro"></span>
        <select id="cambioCentro">
          <option value="" disabled selected hidden></option>
          <option value="yes"></option>
          <option value="no"></option>
        </select>
      </label>
    </div>
    <br>


    <h2 id="creditsTitle"></h2>

    <div class="centered-button">
      <button id="addCreditSectionBtn"></button>
    </div>

    <div id="creditSectionTeorici" class="section"style="display:none; position:relative;">
      <button id="closeCreditiBtn" class="remove-period-btn" style="top: -18px; right: -18px;">‚úñ</button>
      <label for="creditiTeorici" id="labelTeorici"></label>
      <input type="number" id="creditiTeorici" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
      <div class="small-title" id="introTitle"></div>
      <label id="introProgramLabel" for="introProgram"></label>
      <select id="introProgram">
        <option value=""></option>
        <option value="2024"></option>
        <option value="2009"></option>
      </select>
      <div id="intro2024Fields" style="display:none; margin-top:8px;">
        <label for="creditiCorso2024" id="labelCorso2024"></label>
        <input type="number" id="creditiCorso2024" min="1" max="50" placeholder="0">
      </div>
      <div id="intro2009Fields" class="checkbox-group" style="display:none; margin-top:8px;">
        <label><input type="checkbox" id="corsoCog"><span id="labelCorsoCog"></span></label>
        <label><input type="checkbox" id="corsoPsy"><span id="labelCorsoPsy"></span></label>
        <label><input type="checkbox" id="corsoSis"><span id="labelCorsoSis"></span></label>
      </div>
    </div>

    <div id="creditSectionPsy" class="section" style="display:none;">
      <label for="creditiPsy" id="labelPsy"></label>
      <input type="number" id="creditiPsy" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
    </div>

    <div id="creditSectionCong" class="section" style="display:none;">
      <label for="creditiCong" id="labelCong"></label>
      <input type="number" id="creditiCong" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
      <br><br>
      <label for="partecipazioneSSPP"><span id="labelSSPP"></span>
        <select id="partecipazioneSSPP">
          <option value="" disabled selected hidden></option>
          <option value="yes"></option>
          <option value="no"></option>
        </select>
      </label>
    </div>
    <br>

    <h2 id="supervisionTitle"></h2>

    <div class="centered-button">
      <button id="addSupervisionSectionBtn"></button>
    </div>

    <div id="supervisionSection" class="section" style="display:none; position:relative;">
      <button id="closeSupervisioniBtn" class="remove-period-btn" style="top: -18px; right: -18px;">‚úñ</button>
      <label for="supIPPB"><span id="labelSupIPPB"></span></label>
      <input type="number" id="supIPPB" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
      <br><br>
      <label for="supWeiter"><span id="labelSupWeiter"></span></label>
      <input type="number" id="supWeiter" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
    </div>

    <div id="PsysupervisionSection" class="section" style="display:none;">
      <label for="supSingolo"><span id="labelSupSingolo"></span></label>
      <input type="number" id="supSingolo" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
      <br><br>
      <label for="supGruppo"><span id="labelSupGruppo"></span></label>
      <input type="number" id="supGruppo" min="0" max="500" placeholder="0">
      <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
      <br><br>
      <label for="supChange"><span id="labelSupChange"></span></label>
      <select id="supChange" required>
        <option value="" disabled selected hidden></option>
        <option value="yes"></option>
        <option value="no"></option>
      </select><br><br>
      <label for="supHrsChange"><span id="labelHrsChange"></span></label>
      <select id="supHrsChange" required>
        <option value="" disabled selected hidden></option>
        <option value="yes"></option>
        <option value="no"></option>
      </select><br><br>
    </div>

    <br>
    <hr class="modern-divider">
    <br>
    
    <div class="centered-button">
      <button id="calcBtn" style="display:none"></button>
    </div>

    <button id="pdfButton" style="display:none; margin-bottom: 20px;"></button>

    <h2 id="resultHeader" style="display:none"></h2>


    <div id="errore" class="error-message"></div>

    <div id="risultato"></div>

    <div id="creditiOutput"></div>

    <div id="supervisionOutput"></div>

    <button id="clearButton"></button>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

      const translations = { 
      de: {
          pageTitle:'Berechnung des Ausbildungsfortschritts',
          headerTitle:'Berechnung des Ausbildungsfortschritts',
          headerSubtitle:'Psychiatrie und Psychotherapie bei Erwachsenen',
          disclaimer: 'Dieses Tool wird kostenlos angeboten von der Schweizerischen Vereinigung der Assistenz√§rztinnen und -√§rzte in Psychiatrie (SVPA-ASMAP-ASAP). Das Tool basiert auf der Interpretation der Weiterbildungsprogramme des ISFM-FMH. Die Vereinigung und ihre Mitglieder √ºbernehmen keine Verantwortung bei allf√§lligen Rechenfehlern. Es wird empfohlen, sich stets auf die offiziellen ISFM-FMH-Dokumente zu beziehen.',
          addPeriod:'‚ûï Periode hinzuf√ºgen',
          addCredits:'‚ûï Credits hinzuf√ºgen',
          addSupervisions:'‚ûï Supervisionen hinzuf√ºgen',
          downloadPdf:'üìÑ PDF herunterladen',
          clearAll:'üóëÔ∏è Alles l√∂schen',
          questionGerontoPsy: 'Min. 6 Monate Gerontopsychiatrie?',
          optNoG:'Nein',
          optSiG:'Ja',
          questionCambioCentro:'Art.¬†2.1.2: W√§hrend der Ausbildung gewechselt?',
          optNo:'Nein',
          optSi:'Ja',
          labelTeorici:'Theoretische Credits',
          introTitle:'Einf√ºhrung in Modelle',
          introProgramQuestion:'Nach welchem Programm streben Sie den Facharzttitel an?',
          optProgram2024:'Programm 2024',
          optProgram2009:'Programm 2009',
          labelCorso2024:'Einf√ºhrungskurs Psychotherapie 2024',
          labelCorsoCog:'Kognitiv-Verhaltenstherapie',
          labelCorsoPsy:'Psychodynamisch/Psychoanalytisch',
          labelCorsoSis:'Systemisch',
          labelCorsoCog:'Kognitives Seminar',
          labelCorsoPsy:'Psychodynamischer Kurs',
          labelCorsoSis:'Systemischer Workshop',
          labelPsy:'Psychiatrie-Credits',
          labelCong:'Kongress-Credits',
          labelSSPP:'Teilnahme an SSPP',
          selectPrompt:'Ausw√§hlen...',
          optYes:'Ja',
          optNo2:'Nein',
          calcButton:'üßÆ Fortschritt berechnen',
          resultTitle:'Ergebnis',
          labelSupIPPB:'Anzahl IPPB-Supervisionen tot.',
          labelSupWeiter:'Weiterbildungssupervisionen',
          labelSupSingolo:'Supervisionen Einzelsitzung',
          labelSupGruppo:'Supervisionen Gruppensitzung',
          labelSupChange:'Supervisor gewechselt?',
          labelHrsChange:'Mind. 100h Supervision?',
          supChangePrompt:'Ausw√§hlen...',
          supHrsPrompt:'Ausw√§hlen...',
          supChangeYes:'Ja',
          supChangeNo:'Nein',
          supHrsYes:'Ja',
          supHrsNo:'Nein',
          placeholderTipoAttivita: 'Art der T√§tigkeit ausw√§hlen',
          tipoAdult: 'Psychiatrie und Psychotherapie Erwachsene',
          tipoInfantile: 'Kinder- und Jugendpsychiatrie',
          tipoSomatico: 'Somatisches Jahr',
          tipoRicerca: 'Forschung',
          tipoStudio: 'Arztpraxis',
          placeholderCategoria: 'Kategorie ausw√§hlen',
          catAOsp: 'A Station√§r allgemein',
          catAAmb: 'A Ambulant allgemein',
          catBOsp: 'B Station√§r allgemein',
          catBAmb: 'B Ambulant allgemein',
          catCOsp: 'C Station√§r allgemein',
          catCAmb: 'C Ambulant allgemein',
          catGerOsp: 'Gerontopsychiatrie station√§r',
          catGerAmb: 'Gerontopsychiatrie ambulant',
          catDipOsp: 'Abh√§ngigkeiten station√§r',
          catDipAmb: 'Abh√§ngigkeiten ambulant',
          catForOsp: 'Forensische Psychiatrie station√§r',
          catForAmb: 'Forensische Psychiatrie ambulant',
          catLiaOsp: 'Konsiliar/Liaison station√§r',
          catLiaAmb: 'Konsiliar/Liaison ambulant',
          catOtherOsp: 'Andere station√§re Kategorien',
          catOtherAmb: 'Andere ambulante Kategorien',
          mesiPlaceholder: 'Anzahl Monate eingeben',
          pensumPlaceholder: 'Pensum in % eingeben',
          workTitle: "Arbeitst√§tigkeit",
          creditsTitle: "Ausbildungscredits",
          supervisionTitle: "Supervisionen",
          validMonths: "{v} / 72 g√ºltige Monate",
          comments: "Kommentare",
          formErrors: "Fehler im Formular:",
          removePeriod:'Zeitraum entfernen',
          extraLabel:'Extra',
          missingMonths:'Fehlende Monate',
          periodsNoMissing:'‚úÖ Keine L√ºcken in den eingegebenen Zeitr√§umen.',
          creditsNoMissing:'‚úÖ Keine L√ºcken in den eingegebenen Credits.',
          gerontoComment: "Die Min. 6 obligatorischen Monate in der Gerontopsychiatrie fehlen noch.",
          cambioCentroComment: "Wechsel der Weiterbildungsst√§tte gem√§ss Art. 2.1.2 erforderlich.",
          missingOspA: "Es fehlen {n} Monate in Kategorie A station√§r (mindestens 12)",
          missingTotOsp: "Es fehlen insgesamt {n} Monate T√§tigkeit im station√§ren Bereich (mindestens 24)",
          missingAmbA: "Es fehlen {n} Monate in Kategorie A ambulant (mindestens 12)",
          missingTotAmb: "Es fehlen insgesamt {n} Monate T√§tigkeit im ambulanten Bereich/Praxis (mind. 24)",
          missingSom: "Es fehlen {n} Monate somatische T√§tigkeit (mindestens 12)",
          tooManyOsp: "Du hast {n} station√§re Monate, die nicht angerechnet werden k√∂nnen (maximal 36)",
          tooManyAmb: "Du hast {n} ambulante/Praxis-Monate, die nicht angerechnet werden k√∂nnen (max 36)",
          tooManyExtra: "Du hast {n} Monate Forschung/Kinderpsychiatrie, die nicht angerechnet werden k√∂nnen (max 12)",
          excludedByLimit: "Aufgrund des Gesamtlimits von 60 Monaten f√ºr Psychiatrie und Extra wurden {n} Monate ausgeschlossen",
          categoryMissing: "Periode {p}: Kategorie {cat} fehlt",
          creditiBar: {
              teorici: 'Basistheoretie',
              psy: 'Psychotherapie i.e.S.',
              cong: 'Kongresse',
              missing: 'Fehlende'
          },
          validCredits: "{v} / 600 g√ºltige Credits",
          creditiMissingTeorici: n => `Es fehlen noch <b>${n}</b> theoretische Basiscredits`,
          creditiMissingPsy: n => `Es fehlen noch  <b>${n}</b> Credits f√ºr psychotherapeutische Weiterbildung i.e.S.`,
          creditiMissingCong: n => `Es fehlen noch  <b>${n}</b> Credits f√ºr Kongresse, Workshops und Kurse`,
          creditiMissingIntro: "Du musst noch die Einf√ºhrungskurse in Psychotherapie besuchen (in den 240 Basis-Credits enthalten)",
          creditiMissingIntroSome: mancanti => `Du musst noch die folgende Einf√ºhrungskurse in Psychotherapie besuchen: <b>${mancanti.join(', ')}</b> gem√§ss Weiterbildungsprogramm 2009 oder den neuen 40-Credit-Kurs gem√§ss Weiterbildungsprogramm 2024`,
          creditiMissingIntro2024: n => `Es fehlen noch <b>${n}</b> Credits im Einf√ºhrungskurs Psychotherapie (Programm 2024).`,
          creditiMissingProgram: "Du musst die Frage zum Programm beantworten.",
          creditiMissingSSPP: "Du hast die Frage zur Teilnahme am SGPP-Kongress nicht beantwortet",
          creditiMissingSSPPNo: "Du musst die vollst√§ndige Teilnahme am j√§hrlichen SSPP-Kongress nachweisen",
          supervisionTitle: "Erforderliche Supervisionen",
          supervisionBar: {
            ippb: "IPPB",
            coaching: "Coaching",
            group: "Gruppe",
            ind: "Einzel",
            missing: "Fehlend"
          },
          supervisionMissingIPPB: v => `Es fehlen ${v} IPPB‚ÄëSupervisionen (mindestens 150 erforderlich).`,
          supervisionMissingCoaching: v => `Es fehlen ${v} Coaching‚ÄëSupervisionen (mindestens 30 erforderlich).`,
          supervisionMissingTotPsico: v => `Es fehlen ${v} Psychotherapiesupervisionen insgesamt (Gruppe + Einzel, mindestens 150 erforderlich).`,
          supervisionMissingIndiv: v => `Es fehlen ${v} Einzelsupervisionen (mindestens 15 erforderlich).`,
          supervisionComments: "Kommentare zu den Supervisionen",
          supervisionValid: v => `G√ºltige Supervisionen insgesamt: ${v}`,
          supervisionNoMissing: "‚úÖ Alle Supervisionsanforderungen sind erf√ºllt.",
          supervisionCompilaTutto: "Bitte f√ºlle alle Pflichtfelder der Supervision aus."

        },

        fr:{
          pageTitle:'Calcul de l‚Äôavancement de la formation',
          headerTitle:'Calcul de l‚Äôavancement de la formation',
          headerSubtitle:'Psychiatrie et psychoth√©rapie des adultes',
          disclaimer: 'Cet outil est propos√© gratuitement par l\'Association Suisse des Assistant¬∑e¬∑s en Psychiatrie (SVPA-ASMAP-ASAP). L\'outil est bas√© sur l\'interpr√©tation des programmes de formation de l\'ISFM-FMH. L\'association et ses membres d√©clinent toute responsabilit√© en cas d\'erreurs de calcul. Il est recommand√© de toujours se r√©f√©rer aux documents officiels de l\'ISFM-FMH.',
          addPeriod:'‚ûï Ajouter une p√©riode',
          addCredits:'‚ûï Ajouter des cr√©dits',
          addSupervisions:'‚ûï Ajouter des supervisions',
          downloadPdf:'üìÑ T√©l√©charger le PDF',
          clearAll:'üóëÔ∏è Tout effacer',
          questionGerontoPsy: 'Min. 6 mois de g√©ronto-psychiatrie¬†?',
          optNoG:'Non',
          optSiG:'Oui',
          questionCambioCentro:'Art.¬†2.1.2¬†: Avez-vous chang√©¬†?',
          optNo:'Non',
          optSi:'Oui',
          labelTeorici:'Cr√©dits th√©oriques',
          introTitle:'Introduction mod√®les',
          introProgramQuestion:'Selon quel programme poursuivez-vous le titre de sp√©cialiste¬†?',
          optProgram2024:'Programme 2024',
          optProgram2009:'Programme 2009',
          labelCorso2024:'Cours d‚Äôintroduction √† la psychoth√©rapie 2024',
          labelCorsoCog:'Cognitivo-comportementale',
          labelCorsoPsy:'Psychodynamique/psychanalytique',
          labelCorsoSis:'Syst√©mique',
          labelCorsoCog:'S√©minaire cognitif',
          labelCorsoPsy:'Cours psychodynamique',
          labelCorsoSis:'Atelier syst√©mique',
          labelPsy:'Cr√©dits psychiatrie',
          labelCong:'Cr√©dits congr√®s',
          labelSSPP:'Participation SSPP',
          selectPrompt:'S√©lectionner...',
          optYes:'Oui',
          optNo2:'Non',
          calcButton:'üßÆ Calculer',
          resultTitle:'R√©sultat',
          labelSupIPPB:'Supervisions IPPB totales',
          labelSupWeiter:'Supervisions formation',
          labelSupSingolo:'Supervisions individuel',
          labelSupGruppo:'Supervisions groupe',
          labelSupChange:'Chang√© superviseur¬†?',
          labelHrsChange:'‚â•100h supervision¬†?',
          supChangePrompt:'S√©lectionner...',
          supHrsPrompt:'S√©lectionner...',
          supChangeYes:'Oui',
          supChangeNo:'Non',
          supHrsYes:'Oui',
          supHrsNo:'Non',
          creditiLegenda: "Legenda",
          placeholderTipoAttivita: 'Choisir type d‚Äôactivit√©',
          tipoAdult: 'Psychiatrie et Psychoth√©rapie adultes',
          tipoInfantile: 'Psy enfants/adolescents',
          tipoSomatico: 'Ann√©e somatique',
          tipoRicerca: 'Recherche',
          tipoStudio: 'Cabinet m√©dical',
          placeholderCategoria: 'Choisir cat√©gorie',
          catAOsp: 'A hospitalier g√©n√©ral',
          catAAmb: 'A ambulatoire g√©n√©ral',
          catBOsp: 'B hospitalier g√©n√©ral',
          catBAmb: 'B ambulatoire g√©n√©ral',
          catCOsp: 'C hospitalier g√©n√©ral',
          catCAmb: 'C ambulatoire g√©n√©ral',
          catGerOsp: 'G√©rontopsychiatrie hospitalier',
          catGerAmb: 'G√©rontopsychiatrie ambulatoire',
          catDipOsp: 'D√©pendances hospitalier',
          catDipAmb: 'D√©pendances ambulatoire',
          catForOsp: 'Psychiatrie forensique hospitalier',
          catForAmb: 'Psychiatrie forensique ambulatoire',
          catLiaOsp: 'Consultation et liaison hospitalier',
          catLiaAmb: 'Consultation et liaison ambulatoire',
          catOtherOsp: 'Autres cat√©gories hospitali√®res',
          catOtherAmb: 'Autres cat√©gories ambulatoires',
          mesiPlaceholder: 'Entrer nombre de mois',
          pensumPlaceholder: 'Entrer le pensum en %',
          workTitle: "Activit√© professionnelle",
          creditsTitle: "Cr√©dits de formation",
          supervisionTitle: "Supervisions",
          validMonths: "{v} / 72 mois valides",
          comments: "Commentaires",
          formErrors: "Erreurs dans le formulaire :",
          removePeriod:'Supprimer la p√©riode',
          extraLabel:'Extra',
          missingMonths:'Mois manquants',
          periodsNoMissing:'‚úÖ Aucune lacune dans les p√©riodes saisies.',
          creditsNoMissing:'‚úÖ Aucune lacune dans les cr√©dits saisis.',
          gerontoComment: "Les 6 mois obligatoires en g√©ronto-psychiatrie manquent encore.",
          cambioCentroComment: "Changement de centre de formation selon l‚Äôart. 2.1.2 requis.",
          missingOspA: "Il manque {n} mois en hospitalier cat√©gorie A (minimum 12)",
          missingTotOsp: "Il manque au total {n} mois d‚Äôactivit√© hospitali√®re (minimum 24)",
          missingAmbA: "Il manque {n} mois en ambulatoire cat√©gorie A (minimum 12)",
          missingTotAmb: "Il manque au total {n} mois d‚Äôactivit√© ambulatoire/cabinet m√©dical (minimum 24)",
          missingSom: "Il manque {n} mois d‚Äôactivit√© somatique (minimum 12)",
          tooManyOsp: "Tu as {n} mois hospitaliers qui ne peuvent pas √™tre comptabilis√©s (max 36)",
          tooManyAmb: "Tu as {n} mois ambulatoires/cabinet m√©dical qui ne peuvent pas √™tre pris en compte (max 36)",
          tooManyExtra: "Tu as {n} mois en recherche/p√©dopsychiatrie qui ne peuvent pas √™tre comptabilis√©s (max 12)",
          excludedByLimit: "En raison de la limite totale de 60 mois entre psychiatrie et extra, {n} mois ont √©t√© exclus",
          categoryMissing: "P√©riode {p} : cat√©gorie {cat} manquante",
          creditiBar: {
            teorici: 'Th√©oriques',
            psy: 'Psychoth√©rapie',
            cong: 'Congr√®s',
            missing: 'Manquants'
          },
          validCredits: "{v} / 600 cr√©dits valides",
          creditiMissingTeorici: n => `Il vous manque encore <b>${n}</b> cr√©dits de formation th√©orique.`,
          creditiMissingPsy: n => `Il vous manque encore <b>${n}</b> cr√©dits de formation en psychoth√©rapie.`,
          creditiMissingCong: n => `Il vous manque encore <b>${n}</b> cr√©dits de congr√®s, ateliers et cours.`,
          creditiMissingIntro: "Vous devez encore suivre les cours d‚Äôintroduction √† la psychoth√©rapie (inclus dans les 240 cr√©dits de base).",
          creditiMissingIntroSome: mancanti => `Vous devez encore suivre les cours d‚Äôintroduction √† la psychoth√©rapie suivants¬†: <b>${mancanti.join(', ')}</b> selon le programme 2009 ou bien le nouveau cours complet de 40 cr√©dits du programme 2024.`,
          creditiMissingIntro2024: n => `Il vous manque encore <b>${n}</b> cr√©dits dans le cours d‚Äôintroduction √† la psychoth√©rapie (programme 2024).`,
          creditiMissingProgram: "Vous devez r√©pondre √† la question sur le programme.",
          creditiMissingSSPP: "Vous devez r√©pondre √† la question sur la participation compl√®te au congr√®s annuel de la SSPP.",
          creditiMissingSSPPNo: "La participation compl√®te obligatoire au congr√®s annuel de la SSPP n‚Äôa pas encore √©t√© effectu√©e.",
          supervisionTitle: "Supervisions requises",
          supervisionBar: {
            ippb: "IPPB",
            coaching: "Coaching",
            group: "Groupe",
            ind: "Individuel",
            missing: "Manquantes"
          },
          supervisionMissingIPPB: v => `Il manque ${v} supervisions IPPB (minimum 150 requises).`,
          supervisionMissingCoaching: v => `Il manque ${v} supervisions de coaching (minimum 30 requises).`,
          supervisionMissingTotPsico: v => `Il manque ${v} supervisions de psychoth√©rapie au total (groupe + individuel, minimum 150 requises).`,
          supervisionMissingIndiv: v => `Il manque ${v} supervisions individuelles (minimum 15 requises).`,
          supervisionComments: "Commentaires sur les supervisions",
          supervisionValid: v => `Supervisions valides au total : ${v}`,
          supervisionNoMissing: "‚úÖ Toutes les exigences de supervision sont remplies.",
          supervisionCompilaTutto: "Veuillez remplir tous les champs obligatoires des supervisions."

        },

        it:{
          pageTitle:'Calcolo Avanzamento Formazione',
          headerTitle:'Calcolo Avanzamento Formazione',
          headerSubtitle:'Psichiatria e Psicoterapia degli Adulti',
          disclaimer: 'Questo Tool √® gratuitamente offerto dalla Associazione Svizzera degli Assistenti in Psichiatria (SVPA-ASMAP-ASAP). Il Tool √® basato sull\'interpretazione dei programmi di formazione ISFM-FMH. L‚Äôassociazione e i suoi membri non si ritengono responsabili in caso di errori di conteggio. Si raccomanda di fare sempre riferimento ai documenti ufficiali ISFM-FMH.',
          addPeriod:'‚ûï Aggiungi periodo',
          addCredits:'‚ûï Aggiungi crediti',
          addSupervisions:'‚ûï Aggiungi supervisioni',
          downloadPdf:'üìÑ Scarica PDF',
          clearAll:'üóëÔ∏è Pulisci tutto',
          questionGerontoPsy: 'Min. 6 mesi di gerontopsichiatria?',
          questionCambioCentro:'Art.¬†2.1.2: Durante la formazione hai cambiato centro?',
          optNoG:'No',
          optSiG:'S√¨',
          optNo:'No',
          optSi:'S√¨',
          labelTeorici:'Crediti teorici',
          introTitle:'Introduzione modelli psicoterapeutici',
          introProgramQuestion:'Secondo quale programma stai perseguendo il titolo di specialista?',
          optProgram2024:'Programma 2024',
          optProgram2009:'Programma 2009',
          labelCorso2024:'Corso introduttivo alla psicoterapia 2024',
          labelCorsoCog:'Cognitivo-comportamentale',
          labelCorsoPsy:'Psicodinamica/psicoanalitica',
          labelCorsoSis:'Sistemica',
          labelCorsoCog:'Seminario cognitivo',
          labelCorsoPsy:'Corso psicodinamico',
          labelCorsoSis:'Workshop sistemico',
          labelPsy:'Crediti Psichiatria',
          labelCong:'Crediti Congresso',
          labelSSPP:'Partecipazione SSPP',
          selectPrompt:'Seleziona...',
          optYes:'S√¨',
          optNo2:'No',
          calcButton:'üßÆ Calcola Avanzamento',
          resultTitle:'Risultato',
          labelSupIPPB:'Numero di Supervisioni IPPB totali:',
          labelSupWeiter:'Numero di Supervisioni della Formazione:',
          labelSupSingolo:'Numero di Supervisioni di Psicoterapia in setting singolo:',
          labelSupGruppo:'Numero di Supervisioni di Psicoterapia in setting di gruppo:',
          labelSupChange:'Hai cambiato supervisore di psicoterapia?',
          labelHrsChange:'Hai fatto almeno 100 ore di supervisione?',
          supChangePrompt:'Seleziona...',
          supHrsPrompt:'Seleziona...',
          supChangeYes:'S√¨',supChangeNo:'No',
          supHrsYes:'S√¨',
          supHrsNo:'No',
          placeholderTipoAttivita: 'Scegli tipologia di attivit√†',
          tipoAdult: 'Psichiatria e Psicoterapia Adulti',
          tipoInfantile: 'Psi e Psi Infantile e adolescenziale',
          tipoSomatico: 'Anno somatico',
          tipoRicerca: 'Ricerca',
          tipoStudio: 'Studio Medico',
          placeholderCategoria: 'Scegli categoria',
          catAOsp: 'A ospedaliero generale',
          catAAmb: 'A ambulatoriale generale',
          catBOsp: 'B ospedaliero generale',
          catBAmb: 'B ambulatoriale generale',
          catCOsp: 'C ospedaliero generale',
          catCAmb: 'C ambulatoriale generale',
          catGerOsp: 'Gerontopsichiatria ospedaliera',
          catGerAmb: 'Gerontopsichiatria ambulatoriale',
          catDipOsp: 'Dipendenze ospedaliera',
          catDipAmb: 'Dipendenze ambulatoriale',
          catForOsp: 'Forense ospedaliera',
          catForAmb: 'Forense ambulatoriale',
          catLiaOsp: 'Consiliare e Liaison ospedaliera',
          catLiaAmb: 'Consiliare e Liaison ambulatoriale',
          catOtherOsp: 'Altre categorie ospedaliere',
          catOtherAmb: 'Altre categorie ambulatoriali',
          mesiPlaceholder: 'Inserisci numero di mesi totali',
          pensumPlaceholder: 'Inserisci il pensum in %',
          workTitle: "Attivit√† lavorativa",
          creditsTitle: "Crediti di Formazione",
          supervisionTitle: "Supervisioni",
          validMonths: "{v} / 72 mesi validi",
          comments: "Commento",
          formErrors: "Errori nel form:",
          removePeriod:'Rimuovi periodo',
          extraLabel:'Extra',
          missingMonths:'Mesi mancanti',
          periodsNoMissing:'‚úÖ Non ci sono mancanze nei periodi inseriti.',
          creditsNoMissing:'‚úÖ Non ci sono mancanze nei crediti inseriti.',
          gerontoComment: "Mancano ancora i min. 6 mesi obbligatori in gerontopsichiatria.",
          cambioCentroComment: "√à necessario il cambio del centro di formazione secondo l‚ÄôArt. 2.1.2.",
          missingOspA: "Mancano {n} mesi in Ospedaliero categoria A (minimo 12)",
          missingTotOsp: "Mancano {n} mesi totali di attivit√† ospedaliera (minimo 24)",
          missingAmbA: "Mancano {n} mesi in Ambulatoriale categoria A (minimo 12)",
          missingTotAmb: "Mancano {n} mesi totali di attivit√† ambulatoriale/studio medico (min 24)",
          missingSom: "Mancano {n} mesi di attivit√† somatica (minimo 12)",
          tooManyOsp: "Hai {n} mesi ospedalieri che non possono essere conteggiati (max 36)",
          tooManyAmb: "Hai {n} mesi ambulatoriali/studio medico che non possono essere conteggiati (max 36)",
          tooManyExtra: "Hai {n} mesi in ricerca/infanzia che non possono essere conteggiati (max 12)",
          excludedByLimit: "Per il limite totale di 60 mesi tra psichiatria e extra, sono stati esclusi {n} mesi",
          categoryMissing: "Periodo {p}: categoria {cat} mancante",
          creditiBar: {
              teorici: 'Teorici',
              psy: 'Psicoterapia',
              cong: 'Congressi',
              missing: 'Mancanti'
          },
          validCredits: "{v} / 600 crediti validi",
          creditiMissingTeorici: n => `Ti mancano ancora <b>${n}</b> crediti di formazione teorica.`,
          creditiMissingPsy: n => `Ti mancano ancora <b>${n}</b> crediti di formazione psicoterapeutica.`,
          creditiMissingCong: n => `Ti mancano ancora <b>${n}</b> crediti di congressi, workshop e corsi.`,
          creditiMissingIntro: "Devi ancora frequentare i corsi introduttivi alla psicoterapia (inclusi nei 240 crediti di base).",
          labelCorsoCog: 'cognitivo-comportamentale',
          labelCorsoPsy: 'psicodinamica/psicoanalitica',
          labelCorsoSis: 'sistemica',
          creditiMissingIntroSome: mancanti => `Devi ancora frequentare i seguenti corsi di introduzione alla psicoterapia: <b>${mancanti.join(', ')}</b> secondo programma 2009 oppure il nuovo corso completo da 40 crediti secondo programma 2024.`,
          creditiMissingIntro2024: n => `Ti mancano ancora <b>${n}</b> crediti nel corso introduttivo alla psicoterapia (programma 2024).`,
          creditiMissingProgram: "Devi rispondere alla domanda sul programma.",
          creditiMissingSSPP: "Devi rispondere alla partecipazione completa al congresso annuale SSPP.",
          creditiMissingSSPPNo: "Devi ancora effettuare una partecipazione completa obbligatoria al congresso annuale della SSPP.",
          supervisionTitle: "Supervisioni richieste",
          supervisionBar: {
            ippb: "IPPB",
            coaching: "Coaching",
            group: "Gruppo",
            ind: "Individuale",
            missing: "Mancanti"
          },
          supervisionMissingIPPB: v => `Ti mancano ${v} supervisioni IPPB (minimo 150 richieste).`,
          supervisionMissingCoaching: v => `Ti mancano ${v} supervisioni di coaching (minimo 30 richieste).`,
          supervisionMissingTotPsico: v => `Ti mancano ${v} supervisioni totali di psicoterapia (gruppo + individuali, minimo 150 richieste).`,
          supervisionMissingIndiv: v => `Ti mancano ${v} supervisioni individuali (minimo 15 richieste).`,
          supervisionComments: "Commenti sulle supervisioni",
          supervisionValid: v => `Supervisioni totali valide: ${v}`,
          supervisionNoMissing: "‚úÖ Tutti i requisiti di supervisione sono soddisfatti.",
          supervisionCompilaTutto: "Compila tutti i campi obbligatori delle supervisioni."

          }
      };

      const errorMessages = {
        it: "Uno o pi√π periodi di lavoro inseriti non sono completi o corretti.",
        de: "Ein oder mehrere eingegebene Arbeitsperioden sind unvollst√§ndig oder fehlerhaft.",
        fr: "Une ou plusieurs p√©riodes de travail saisies sont incompl√®tes ou incorrectes.",
        it_select: "Devi rispondere a tutte le domande obbligatorie.",
        de_select: "Bitte beantworte alle Pflichtfragen.",
        fr_select: "Veuillez r√©pondre √† toutes les questions obligatoires."
      };


      function tReplace(str, data) {
        return str.replace(/{(\w+)}/g, (_, k) => data[k]);
      }

      let periodsData = [];

      function getCurrentLang() {
        return document.documentElement.lang || 'de';
      }

      function updateLanguage(lang) {
        const t = translations[lang];
        if (!t) return;

        document.documentElement.lang = lang;
        document.getElementById('pageTitle').textContent = t.pageTitle;
        document.getElementById('headerTitle').textContent = t.headerTitle;
        document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
        document.getElementById('disclaimer').innerHTML = t.disclaimer;
        document.getElementById('addPeriodBtn').textContent = t.addPeriod;
        document.getElementById('addCreditSectionBtn').textContent = t.addCredits;
        document.getElementById('addSupervisionSectionBtn').textContent = t.addSupervisions;
        document.getElementById('pdfButton').textContent = t.downloadPdf;
        document.getElementById('clearButton').textContent = t.clearAll;
        document.getElementById('labelGerontoPsy').textContent = t.questionGerontoPsy;
        document.getElementById('labelCambioCentro').textContent = t.questionCambioCentro;
        document.getElementById('workTitle').textContent = t.workTitle;
        document.getElementById('creditsTitle').textContent = t.creditsTitle;
        document.getElementById('supervisionTitle').textContent = t.supervisionTitle;

        const gerntoPsySel = document.getElementById('gerontoPsy');
        gerntoPsySel.options[0].textContent = t.selectPrompt;
        gerntoPsySel.options[1].textContent = t.optSiG;
        gerntoPsySel.options[2].textContent = t.optNoG;
        
        const cambioCentroSel = document.getElementById('cambioCentro');
        cambioCentroSel.options[0].textContent = t.selectPrompt;
        cambioCentroSel.options[1].textContent = t.optSi;
        cambioCentroSel.options[2].textContent = t.optNo;

        document.getElementById('labelTeorici').textContent = t.labelTeorici;
        document.getElementById('introTitle').textContent = t.introTitle;
        document.getElementById('introProgramLabel').textContent = t.introProgramQuestion;
        const introSel = document.getElementById('introProgram');
        introSel.options[0].textContent = t.selectPrompt;
        introSel.options[1].textContent = t.optProgram2024;
        introSel.options[2].textContent = t.optProgram2009;
        document.getElementById('labelCorso2024').textContent = t.labelCorso2024;
        document.getElementById('labelCorsoCog').textContent = t.labelCorsoCog;
        document.getElementById('labelCorsoPsy').textContent = t.labelCorsoPsy;
        document.getElementById('labelCorsoSis').textContent = t.labelCorsoSis;
        document.getElementById('labelPsy').textContent = t.labelPsy;
        document.getElementById('labelCong').textContent = t.labelCong;
        document.getElementById('labelSSPP').textContent = t.labelSSPP;

        const sss = document.getElementById('partecipazioneSSPP');
        sss.options[0].textContent = t.selectPrompt;
        sss.options[1].textContent = t.optYes;
        sss.options[2].textContent = t.optNo2;

        document.getElementById('calcBtn').textContent = t.calcButton;
        document.getElementById('resultHeader').textContent = t.resultTitle;
        document.getElementById('labelSupIPPB').textContent = t.labelSupIPPB;
        document.getElementById('labelSupWeiter').textContent = t.labelSupWeiter;
        document.getElementById('labelSupSingolo').textContent = t.labelSupSingolo;
        document.getElementById('labelSupGruppo').textContent = t.labelSupGruppo;
        document.getElementById('labelSupChange').textContent = t.labelSupChange;
        document.getElementById('labelHrsChange').textContent = t.labelHrsChange;

        const sc = document.getElementById('supChange');
        sc.options[0].textContent = t.selectPrompt;
        sc.options[1].textContent = t.supChangeYes;
        sc.options[2].textContent = t.supChangeNo;

        const shc = document.getElementById('supHrsChange');
        shc.options[0].textContent = t.selectPrompt;
        shc.options[1].textContent = t.supHrsYes;
        shc.options[2].textContent = t.supHrsNo;

        document.getElementById('selected-lang').textContent = lang.toUpperCase();

        updateResultsUI();

        renderPeriods();

      }

      document.getElementById('closeCreditiBtn').onclick = function() {
        ['creditSectionTeorici', 'creditSectionPsy', 'creditSectionCong'].forEach(id => {
          document.getElementById(id).style.display = 'none';
        });
        creditiMostrati = false;
        ['creditiTeorici','creditiPsy','creditiCong','creditiCorso2024','corsoCog','corsoPsy','corsoSis','introProgram','partecipazioneSSPP'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (el.type === 'checkbox') el.checked = false;
          else if (el.tagName === 'SELECT') el.selectedIndex = 0;
          else el.value = '';
        });
        document.getElementById('intro2024Fields').style.display = 'none';
        document.getElementById('intro2009Fields').style.display = 'none';
        document.getElementById('addCreditSectionBtn').style.display = 'inline-block';
        checkShowCalcButton();
        updateResultsUI();
      };

      document.getElementById('closeSupervisioniBtn').onclick = function() {
        ['supervisionSection', 'PsysupervisionSection'].forEach(id => {
          document.getElementById(id).style.display = 'none';
        });
        supervisioniMostrate = false;
        ['supIPPB','supWeiter','supSingolo','supGruppo','supChange','supHrsChange'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (el.tagName === 'SELECT') el.selectedIndex = 0;
          else el.value = '';
        });
        document.getElementById('addSupervisionSectionBtn').style.display = 'inline-block';
        checkShowCalcButton();
        updateResultsUI();
      };

      function isVisible(el) {
        // Return true if the element is visible in the DOM
        return !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length);
      }

      function checkShowCalcButton() {
        let someInput = false;

        // Work periods (at least one must be entered)
        if (periodsData.some(p =>
          p.tipoAttivita ||
          p.categoria ||
          p.mesi ||
          (p.pensum && p.pensum !== '')
        )) someInput = true;

        // Credits: check only the visible credit section
        ['creditSectionTeorici', 'creditSectionPsy', 'creditSectionCong'].forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section && isVisible(section)) {
            section.querySelectorAll('input, select').forEach(input => {
              if (
                (input.type === 'checkbox' && input.checked) ||
                (input.type !== 'checkbox' && input.value)
              ) {
                someInput = true;
              }
            });
          }
        });

        // Supervisions: check only the visible section
        ['supervisionSection', 'PsysupervisionSection'].forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section && isVisible(section)) {
            section.querySelectorAll('input, select').forEach(input => {
              if (
                (input.type === 'checkbox' && input.checked) ||
                (input.type !== 'checkbox' && input.value)
              ) {
                someInput = true;
              }
            });
          }
        });

        
        periodiContainer.addEventListener('click', (e) => {
          if (e.target.classList.contains('remove-period-btn')) {
            const idx = +e.target.closest('.periodo').dataset.idx;
            periodsData.splice(idx, 1);
            renderPeriods();
            // Hide the box if all periods have been removed
            const domandeBox = document.getElementById('DomcambioCentro');
            if (periodsData.length === 0) {
              domandeBox.style.display = "none";
              primaAggiunta = true;
            }
            updateResultsUI();
          }
        });

        document.getElementById('calcBtn').style.display = someInput ? 'inline-block' : 'none';
      }



      function renderPeriods() {
        const t = translations[getCurrentLang()];
        const container = document.getElementById('periodi');
        container.innerHTML = '';

        periodsData.forEach((period, idx) => {
          const div = document.createElement('div');
          div.className = 'periodo';
          div.dataset.idx = idx; 
          div.innerHTML = `
            <button type="button" class="remove-period-btn" title="${t.removePeriod}">‚úñ</button>

            <label>
              <select class="tipo-attivita">
                <option value="" disabled ${!period.tipoAttivita ? "selected" : ""} hidden>${t.placeholderTipoAttivita}</option>
                <option value="adult" ${period.tipoAttivita === "adult" ? "selected" : ""}>${t.tipoAdult}</option>
                <option value="som" ${period.tipoAttivita === "som" ? "selected" : ""}>${t.tipoSomatico}</option>
                <option value="inf" ${period.tipoAttivita === "inf" ? "selected" : ""}>${t.tipoInfantile}</option>
                <option value="studio" ${period.tipoAttivita === "studio" ? "selected" : ""}>${t.tipoStudio}</option>
                <option value="ric" ${period.tipoAttivita === "ric" ? "selected" : ""}>${t.tipoRicerca}</option>
              </select>
            </label>

            <label class="categoria-label" style="${period.tipoAttivita === 'adult' ? '' : 'display:none'}">
              <select class="categoria-attivita">
                <option value="" disabled ${!period.categoria ? "selected" : ""} hidden>${t.placeholderCategoria}</option>
                <option value="ospA" ${period.categoria === "ospA" ? "selected" : ""}>${t.catAOsp}</option>
                <option value="ospB" ${period.categoria === "ospB" ? "selected" : ""}>${t.catBOsp}</option>
                <option value="ospC" ${period.categoria === "ospC" ? "selected" : ""}>${t.catCOsp}</option>
                <option value="ambA" ${period.categoria === "ambA" ? "selected" : ""}>${t.catAAmb}</option>
                <option value="ambB" ${period.categoria === "ambB" ? "selected" : ""}>${t.catBAmb}</option>
                <option value="ambC" ${period.categoria === "ambC" ? "selected" : ""}>${t.catCAmb}</option>
                <option value="gerOsp" ${period.categoria === "gerOsp" ? "selected" : ""}>${t.catGerOsp}</option>
                <option value="gerAmb" ${period.categoria === "gerAmb" ? "selected" : ""}>${t.catGerAmb}</option>
                <option value="dipOsp" ${period.categoria === "dipOsp" ? "selected" : ""}>${t.catDipOsp}</option>
                <option value="dipAmb" ${period.categoria === "dipAmb" ? "selected" : ""}>${t.catDipAmb}</option>
                <option value="forOsp" ${period.categoria === "forOsp" ? "selected" : ""}>${t.catForOsp}</option>
                <option value="forAmb" ${period.categoria === "forAmb" ? "selected" : ""}>${t.catForAmb}</option>
                <option value="liaOsp" ${period.categoria === "liaOsp" ? "selected" : ""}>${t.catLiaOsp}</option>
                <option value="liaAmb" ${period.categoria === "liaAmb" ? "selected" : ""}>${t.catLiaAmb}</option>
              </select>
            </label>
            
            <label>
              <input type="number" min="0" max="100" class="mesi" placeholder="${t.mesiPlaceholder}" value="${period.mesi || ''}">
              <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
            </label>
          
            <label>
              <input type="number" min="0" max="100" class="pensum" placeholder="${t.pensumPlaceholder}" value="${period.pensum || ''}">
              <span class="input-error" style="display:none;color:#dc3545;font-size:0.98em;margin-top:2px"></span>
            </label>
          `;
            const domandeBox = document.getElementById('DomcambioCentro');
            if (periodsData.length === 0) {
              domandeBox.style.display = "none";
              primaAggiunta = true; // so when a period is re-added the box reappears
            }
          container.appendChild(div);
        });
      }

      const periodiContainer = document.getElementById('periodi');

      periodiContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-period-btn')) {
            const idx = +e.target.closest('.periodo').dataset.idx;
          periodsData.splice(idx, 1);
          renderPeriods();
        }
      });

      periodiContainer.addEventListener('change', (e) => {
        const periodoDiv = e.target.closest('.periodo');
        if (!periodoDiv) return;
        const idx = +periodoDiv.dataset.idx;

        if (e.target.classList.contains('tipo-attivita')) {
          periodsData[idx].tipoAttivita = e.target.value;
          if (e.target.value !== 'adult') periodsData[idx].categoria = '';
          renderPeriods();
        }

        if (e.target.classList.contains('categoria-attivita')) {
          periodsData[idx].categoria = e.target.value;
          renderPeriods();
        }
      });

      periodiContainer.addEventListener('input', (e) => {
        const periodoDiv = e.target.closest('.periodo');
        if (!periodoDiv) return;
        const idx = +periodoDiv.dataset.idx;

        const errorSpan = e.target.parentElement.querySelector('.input-error');
        let v = parseInt(e.target.value, 10);

        if (e.target.classList.contains('mesi') || e.target.classList.contains('pensum')) {
          if (isNaN(v) || v < 1 || v > 100) {
            errorSpan.textContent = 'Value must be between 1 and 100';
            errorSpan.style.display = 'block';
            e.target.classList.add('error');
            if (e.target.classList.contains('mesi')) periodsData[idx].mesi = '';
            else if (e.target.classList.contains('pensum')) periodsData[idx].pensum = '';
          } else {
            errorSpan.textContent = '';
            errorSpan.style.display = 'none';
            e.target.classList.remove('error');
            if (e.target.classList.contains('mesi')) periodsData[idx].mesi = v;
            else if (e.target.classList.contains('pensum')) periodsData[idx].pensum = v;
          }
        }
      });

      let primaAggiunta = true;
      let creditiMostrati = false;
      let supervisioniMostrate = false;

      document.getElementById('addPeriodBtn').onclick = () => {
        const domandeBox = document.getElementById('DomcambioCentro');
        if (primaAggiunta) {
          domandeBox.style.display = "block";       
          periodsData.push({ tipoAttivita: '', categoria: '', mesi: '', pensum: '' });
          renderPeriods();
          primaAggiunta = false;
          return;
        }
        periodsData.push({ tipoAttivita: '', categoria: '', mesi: '', pensum: '' });
        renderPeriods();
      };

      document.getElementById('addCreditSectionBtn').onclick = () => {
        if (!creditiMostrati) {
          document.getElementById('creditSectionTeorici').style.display = "block";
          document.getElementById('creditSectionPsy').style.display = "block";
          document.getElementById('creditSectionCong').style.display = "block";
          document.getElementById('addCreditSectionBtn').style.display = "none";
          creditiMostrati = true;
        }
      };

      document.getElementById('addSupervisionSectionBtn').onclick = () => {
        if (!supervisioniMostrate) {
          document.getElementById('supervisionSection').style.display = "block";
          document.getElementById('PsysupervisionSection').style.display = "block";
          document.getElementById('addSupervisionSectionBtn').style.display = "none";
          supervisioniMostrate = true;
        }
      };

      document.getElementById('clearButton').onclick = () => {
        periodsData = [];
        renderPeriods();
        document.getElementById('resultHeader').style.display = 'none';
        document.querySelectorAll('#creditiTeorici, #creditiPsy, #creditiCong, #supIPPB, #supWeiter, #supSingolo, #supGruppo').forEach(inp => inp.value = '');
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        ['cambioCentro', 'gerontoPsy', 'partecipazioneSSPP', 'supChange', 'supHrsChange'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.selectedIndex = 0;
        });
        document.getElementById('risultato').innerHTML = '';
        document.getElementById('pdfButton').style.display = "none";
        updateResultsUI();
      };


      document.querySelectorAll(
        'input, select'
      ).forEach(el => {
        el.addEventListener('input', checkShowCalcButton);
        el.addEventListener('change', checkShowCalcButton);
      });
      const oldRenderPeriods = renderPeriods;
      renderPeriods = function() {
        oldRenderPeriods();
        document.querySelectorAll(
          'input, select'
        ).forEach(el => {
          el.addEventListener('input', checkShowCalcButton);
          el.addEventListener('change', checkShowCalcButton);
        });
        checkShowCalcButton();
      };


      checkShowCalcButton();


      function calculateResult() {
        const domandeBox = document.getElementById('DomcambioCentro');
        if (!isVisible(domandeBox)) {
          document.getElementById('risultato').innerHTML = '';
          return;
        }

        const lang = getCurrentLang();
        const t = translations[lang];
        let messaggiErrore = [];
        let mancanze = [];
        const gerontoPsy = document.getElementById('gerontoPsy').value;
        const cambioCentro = document.getElementById('cambioCentro').value;
        let html1 = `<h2 class="result-box-title">${t.workTitle}</h2>`;

        document.querySelectorAll('.periodo').forEach(div => div.classList.remove('errore-periodo'));
        let erroreSelect = false;
        ['cambioCentro', 'gerontoPsy', 'partecipazioneSSPP', 'supChange', 'supHrsChange'].forEach(id => {
          const el = document.getElementById(id);
          if (el && isVisible(el)) {
            if (el.selectedIndex === 0) {
              el.classList.add('errore-select');
              erroreSelect = true;
            } else {
              el.classList.remove('errore-select');
            }
          }
        });


        if (erroreSelect) messaggiErrore.push(errorMessages[lang + '_select']);

        let errorePeriodi = false;
        document.querySelectorAll('.periodo').forEach((div, idx) => {
          const p = periodsData[idx];
          if (
            !p.tipoAttivita ||
            (p.tipoAttivita === "adult" && !p.categoria) ||
            !p.mesi ||
            (!p.pensum && p.pensum !== 0)
          ) {
            errorePeriodi = true;
            div.classList.add('errore-periodo');
          } else {
            div.classList.remove('errore-periodo');
          }
        });

        if (errorePeriodi) messaggiErrore.push(errorMessages[lang]);

        if (messaggiErrore.length > 0) {
          document.getElementById('errore').innerHTML = messaggiErrore.join('<br>');
          document.getElementById('risultato').innerHTML = '';
          return;
        } else {
          document.getElementById('errore').textContent = '';
        }

        if (gerontoPsy === 'no') {
          mancanze.push(t.gerontoComment);
        }

        if (cambioCentro === 'no') {
          mancanze.push(t.cambioCentroComment);
        }

        const cat = {
          ospA: 0, ospB: 0, ospC: 0,
          ambA: 0, ambB: 0, ambC: 0,
          ospOther: 0, ambOther: 0,
          studio: 0, som: 0, infanzia: 0, ricerca: 0
        };

        periodsData.forEach(p => {
          const mesi = parseFloat(p.mesi) || 0;
          const pensum = parseFloat(p.pensum) || 100;
          const mesiEff = mesi * pensum / 100;
          if (p.tipoAttivita === "som") cat.som += mesiEff;
          else if (p.tipoAttivita === "inf") cat.infanzia += mesiEff;
          else if (p.tipoAttivita === "ric") cat.ricerca += mesiEff;
          else if (p.tipoAttivita === "studio") cat.studio += mesiEff;
          else if (p.tipoAttivita === "adult") {
            switch (p.categoria) {
              case "ospA": cat.ospA += mesiEff; break;
              case "ospB": cat.ospB += mesiEff; break;
              case "ospC": cat.ospC += mesiEff; break;
              case "ambA": cat.ambA += mesiEff; break;
              case "ambB": cat.ambB += mesiEff; break;
              case "ambC": cat.ambC += mesiEff; break;
              case "gerOsp":
              case "dipOsp":
              case "forOsp":
              case "liaOsp": cat.ospOther += mesiEff; break;
              case "gerAmb":
              case "dipAmb":
              case "forAmb":
              case "liaAmb": cat.ambOther += mesiEff; break;
            }
          }
        });

        const ospA = Math.min(cat.ospA, 36), ospB = Math.min(cat.ospB, 24), ospC = Math.min(cat.ospC, 24), ospOther = cat.ospOther;
        const ambA = Math.min(cat.ambA, 36), ambB = Math.min(cat.ambB, 24), ambC = Math.min(cat.ambC, 24), ambOther = cat.ambOther;
        const studio = cat.studio;
        const somatico = Math.min(cat.som, 12);
        const extra = cat.infanzia + cat.ricerca;
        let extraValido = Math.min(extra, 12);

        const totaleOsp = cat.ospA + cat.ospB + cat.ospC + cat.ospOther;
        const totaleAmb = cat.ambA + cat.ambB + cat.ambC + cat.ambOther + cat.studio;

        let ospedalieroValido = Math.min(totaleOsp, 36);
        let ambulatorialeValido = Math.min(totaleAmb, 36);
        let totalePsichiatriaExtra = ospedalieroValido + ambulatorialeValido + extraValido;

        if (totalePsichiatriaExtra > 60) {
          let eccesso = totalePsichiatriaExtra - 60;
          if (extraValido >= eccesso) { extraValido -= eccesso; eccesso = 0; }
          else { eccesso -= extraValido; extraValido = 0; }
          if (eccesso > 0) {
            if (ambulatorialeValido >= eccesso) { ambulatorialeValido -= eccesso; eccesso = 0; }
            else { eccesso -= ambulatorialeValido; ambulatorialeValido = 0; }
          }
          if (eccesso > 0) {
            ospedalieroValido -= eccesso;
            if (ospedalieroValido < 0) ospedalieroValido = 0;
          }
        }

        const totaleOspPreTaglio = ospA + ospB + ospC + ospOther;
        let ospAValido = 0, ospBValido = 0, ospCValido = 0, ospOtherValido = 0;
        if (totaleOspPreTaglio > 0) {
          const ratioOsp = ospedalieroValido / totaleOspPreTaglio;
          ospAValido = ospA * ratioOsp;
          ospBValido = ospB * ratioOsp;
          ospCValido = ospC * ratioOsp;
          ospOtherValido = ospOther * ratioOsp;
        }
        const totaleAmbPreTaglio = ambA + ambB + ambC + ambOther + studio;
        let ambAValido = 0, ambBValido = 0, ambCValido = 0, ambOtherValido = 0, studioValido = 0;
        if (totaleAmbPreTaglio > 0) {
          const ratioAmb = ambulatorialeValido / totaleAmbPreTaglio;
          ambAValido = ambA * ratioAmb;
          ambBValido = ambB * ratioAmb;
          ambCValido = ambC * ratioAmb;
          ambOtherValido = ambOther * ratioAmb;
          studioValido = studio * ratioAmb;
        }
        const totale = somatico + ospedalieroValido + ambulatorialeValido + extraValido;

        const bar = x => (x / 72) * 100;
        html1 += `<div class="stacked-bar-container" style="display:flex;height:20px;width:100%;border-radius:10px;overflow:hidden;margin-bottom:12px">`;
        if (ospAValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ospAValido)}%; background:darkgreen;" title="${t.catAOsp}"></div>`;
        if (ospBValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ospBValido)}%; background:#6fcf97;" title="${t.catBOsp}"></div>`;
        if (ospCValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ospCValido)}%; background:#a8e6cf;" title="${t.catCOsp}"></div>`;

        if (ospOtherValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ospOtherValido)}%; background:#82e0aa;" title="${t.catOtherOsp}"></div>`;
        if (ambAValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambAValido)}%; background:darkblue;" title="${t.catAAmb}"></div>`;
        if (ambBValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambBValido)}%; background:#5dade2;" title="${t.catBAmb}"></div>`;
        if (ambCValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambCValido)}%; background:#aed6f1;" title="${t.catCAmb}"></div>`;
        if (ambOtherValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambOtherValido)}%; background:#85c1e9;" title="${t.catOtherAmb}"></div>`;

        if (ambAValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambAValido)}%; background:darkblue;" title="${t.catAAmb}"></div>`;
        if (ambBValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambBValido)}%; background:#5dade2;" title="${t.catBAmb}"></div>`;
        if (ambCValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(ambCValido)}%; background:#aed6f1;" title="${t.catCAmb}"></div>`;

        if (studioValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(studioValido)}%; background:#d4e6f1;" title="${t.tipoStudio}"></div>`;
        if (somatico > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(somatico)}%; background:gold;" title="${t.tipoSomatico}"></div>`;
        if (extraValido > 0) html1 += `<div class="stacked-bar-segment" style="width:${bar(extraValido)}%; background:violet;" title="${t.extraLabel}"></div>`;
        if (totale < 72) html1 += `<div class="stacked-bar-segment" style="width:${bar(72 - totale)}%; background:#ccc;" title="${t.missingMonths}"></div>`;
        html1 += `</div>`;

        html1 += `<div class="legenda" style="margin-bottom:16px">`;
        if (ospA > 0) html1 += `<span style="background:darkgreen;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catAOsp}</span>`;
        if (ospB > 0) html1 += `<span style="background:#6fcf97;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catBOsp}</span>`;
        if (ospC > 0) html1 += `<span style="background:#a8e6cf;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catCOsp}</span>`;
        if (ospOther > 0) html1 += `<span style="background:#82e0aa;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catOtherOsp}</span>`;
        if (ambA > 0) html1 += `<span style="background:darkblue;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catAAmb}</span>`;
        if (ambB > 0) html1 += `<span style="background:#5dade2;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catBAmb}</span>`;
        if (ambC > 0) html1 += `<span style="background:#aed6f1;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catCAmb}</span>`;
        if (ambOther > 0) html1 += `<span style="background:#85c1e9;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.catOtherAmb}</span>`;
        if (studio > 0) html1 += `<span style="background:#d4e6f1;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.tipoStudio}</span>`;
        if (somatico > 0) html1 += `<span style="background:gold;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.tipoSomatico}</span>`;
        if (extraValido > 0) html1 += `<span style="background:violet;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.extraLabel}</span>`;
        if (totale < 72) html1 += `<span style="background:#ccc;color:white;padding:2px 8px;border-radius:8px;margin-right:5px">${t.missingMonths}</span>`;
        html1 += `</div>`;

        if (ospA < 12) mancanze.push(tReplace(t.missingOspA, { n: Math.round(12 - ospA) }));
        if (totaleOsp < 24) mancanze.push(tReplace(t.missingTotOsp, { n: Math.round(24 - totaleOsp) }));
        if (ambA < 12) mancanze.push(tReplace(t.missingAmbA, { n: Math.round(12 - ambA) }));
        if (totaleAmb < 24) mancanze.push(tReplace(t.missingTotAmb, { n: Math.round(24 - totaleAmb) }));
        if (somatico < 12) mancanze.push(tReplace(t.missingSom, { n: Math.round(12 - somatico) }));
        if (totaleOsp > 36) mancanze.push(tReplace(t.tooManyOsp, { n: Math.round(totaleOsp - 36) }));
        if (totaleAmb > 36) mancanze.push(tReplace(t.tooManyAmb, { n: Math.round(totaleAmb - 36) }));
        if (extra > 12) mancanze.push(tReplace(t.tooManyExtra, { n: Math.round(extra - 12) }));
        const totalePsichiatriaExtra2 = ospedalieroValido + ambulatorialeValido + extraValido;
        if (totalePsichiatriaExtra2 < (ospedalieroValido + ambulatorialeValido + extra)) {
          const taglio = Math.round((ospedalieroValido + ambulatorialeValido + extra) - totalePsichiatriaExtra2);
          mancanze.push(tReplace(t.excludedByLimit, { n: taglio }));
        }
        if (gerontoPsy === 'no') mancanze.push(t.gerontoComment);
        if (cambioCentro === 'no') mancanze.push(t.cambioCentroComment);

        html1 += `<h3 style="color:coral">${t.comments}</h3>`;
        html1 += `<p><strong>${tReplace(t.validMonths, { v: totale.toFixed(1) })}</strong></p>`;
        if (mancanze.length > 0) {
          html1 += '<ul>';
          mancanze.forEach(m => html1 += `<li>${m}</li>`);
          html1 += '</ul>';
        } else {
        html1 += `<p style="color:green"><b>${t.periodsNoMissing}</b></p>`;
        }

        document.getElementById('risultato').innerHTML = `<div class="section">${html1}</div>`;
      }


      function calcolaCrediti() {
        const creditSectionTeorici = document.getElementById('creditSectionTeorici');
        if (!isVisible(creditSectionTeorici)) {
          document.getElementById('creditiOutput').innerHTML = '';
          return;
        }
        const lang = getCurrentLang();
        const t = translations[lang];
        const output = document.getElementById('creditiOutput');
        let html2 = `<h2 class="result-box-title">${t.creditsTitle}</h2>`;
        const partecipazione = document.getElementById('partecipazioneSSPP').value;
        let mancanze = [];

        if (!partecipazione) {
          output.innerHTML = `<p class="error-message">${t.creditiMissingSSPP}</p>`;
          return;
        }
    
        if (partecipazione === 'no') {
          mancanze.push(t.creditiMissingSSPPNo);
        }

        const teoriciBase = parseFloat(document.getElementById('creditiTeorici').value) || 0;
        const program = document.getElementById('introProgram').value;
        let introCrediti = 0;
        let corsi2009 = [];
        if (program === '2024') {
          introCrediti = parseFloat(document.getElementById('creditiCorso2024').value) || 0;
        } else if (program === '2009') {
          corsi2009 = [
            { id: 'corsoCog', label: t.labelCorsoCog },
            { id: 'corsoPsy', label: t.labelCorsoPsy },
            { id: 'corsoSis', label: t.labelCorsoSis }
          ];
          introCrediti = corsi2009.filter(c => document.getElementById(c.id).checked).length * 12;
        }

        const teorici = teoriciBase + introCrediti;
        const psy = parseFloat(document.getElementById('creditiPsy').value) || 0;
        const cong = parseFloat(document.getElementById('creditiCong').value) || 0;
        const maxTeorici = 240, maxPsy = 180, maxCong = 180;

        html2 += `<div class="stacked-bar-container" style="margin-bottom:10px;display:flex;width:100%;height:22px;border-radius:9px;overflow:hidden">`;
        const totalCrediti = Math.min(teorici, maxTeorici) + Math.min(psy, maxPsy) + Math.min(cong, maxCong);
        const segm = [
          { val: Math.min(teorici, maxTeorici), color: 'darkgreen', label: t.creditiBar.teorici },
          { val: Math.min(psy, maxPsy), color: 'darkblue', label: t.creditiBar.psy },
          { val: Math.min(cong, maxCong), color: 'purple', label: t.creditiBar.cong },
          { val: Math.max(0, 600 - totalCrediti), color: '#ccc', label: t.creditiBar.missing }
        ];
    
        segm.forEach(s => {
          html2 += `<div class="stacked-bar-segment" style="width:${(s.val/600*100).toFixed(1)}%;background:${s.color}" title="${s.label}: ${s.val}"></div>`;
        });
    
        html2 += '</div>';

        html2 += `<div style="margin-bottom:12px;">`;
    
        segm.forEach(s => {
          if (s.val > 0) html2 += `<span style="display:inline-block;margin-right:7px;background:${s.color};padding:2px 9px;border-radius:7px;color:#fff;font-size:0.99em">${s.label}</span>`;
        });
          
        html2 += `</div>`;
    
        if (teorici < maxTeorici) mancanze.push(t.creditiMissingTeorici(maxTeorici - teorici));
        if (psy < maxPsy) mancanze.push(t.creditiMissingPsy(maxPsy - psy));
        if (cong < maxCong) mancanze.push(t.creditiMissingCong(maxCong - cong));


        if (program === '2024') {
          if (introCrediti < 40) mancanze.push(t.creditiMissingIntro2024(40 - introCrediti));
        } else if (program === '2009') {


        if (program === '2024') {
          if (introCrediti < 40) mancanze.push(t.creditiMissingIntro2024(40 - introCrediti));
        } else if (program === '2009') {

        const program = document.getElementById('introProgram').value;
        if (program === '2024') {
          const intro = parseFloat(document.getElementById('creditiCorso2024').value) || 0;
          if (intro < 40) mancanze.push(t.creditiMissingIntro2024(40 - intro));
        } else if (program === '2009') {
          const corsi2009 = [
            { id: 'corsoCog', label: t.labelCorsoCog },
            { id: 'corsoPsy', label: t.labelCorsoPsy },
            { id: 'corsoSis', label: t.labelCorsoSis }
          ];


          const selezionati2009 = corsi2009.filter(c => document.getElementById(c.id).checked);
          if (selezionati2009.length === 0) {
            mancanze.push(t.creditiMissingIntro);
          } else if (selezionati2009.length < corsi2009.length) {
            const mancanti = corsi2009.filter(c => !document.getElementById(c.id).checked).map(c => c.label);
            mancanze.push(t.creditiMissingIntroSome(mancanti));
          }
        } else {
          mancanze.push(t.creditiMissingProgram);
        }

    
        html2 += `<h3 style="color:coral; margin-top: 18px;">${t.comments}</h3>`;
        html2 += `<p style="margin-bottom:8px;"><strong>${tReplace(t.validCredits, { v: totalCrediti })}</strong></p>`;
        if (mancanze.length > 0) {
          html2 += `<ul>`;
          mancanze.forEach(m => html2 += `<li>${m}</li>`);
          html2 += `</ul>`;
        } else {
          html2 += `<p style="color:green"><b>${t.creditsNoMissing}</b></p>`;
        }
        output.innerHTML = `<div class="section">${html2}</div>`;
      }

      function calcolaSupervisioni() {
        // Identify both supervision sections (both must be hidden to reset)
        const sec1 = document.getElementById('supervisionSection');
        const sec2 = document.getElementById('PsysupervisionSection');
        const output = document.getElementById('supervisionOutput');

        // If both sections are not visible, clear and return
        if (!isVisible(sec1) && !isVisible(sec2)) {
          output.innerHTML = '';
          return;
        }

        // Set language and translations
        const lang = getCurrentLang();
        const t = translations[lang];

        // Supervision section header
        let html3 = `<h2 class="result-box-title">${t.supervisionTitle}</h2>`;
        let mancanze = [];

        // Retrieve values from inputs
        const ippb    = parseFloat(document.getElementById('supIPPB').value)    || 0;
        const coaching = parseFloat(document.getElementById('supWeiter').value) || 0;
        const singolo = parseFloat(document.getElementById('supSingolo').value) || 0;
        const gruppo  = parseFloat(document.getElementById('supGruppo').value)  || 0;
        const change  = document.getElementById('supChange').value;
        const hrs     = document.getElementById('supHrsChange').value;
 
        // If required fields are missing or invalid, show warning and return
        if (ippb < 0 || coaching < 0 || singolo < 0 || gruppo < 0 || !change || !hrs) {
          output.innerHTML = `<p class="error-message">${t.supervisionCompilaTutto}</p>`;
          return;
        }

        // Define thresholds
        const sogliaIPPB     = 150;
        const sogliaCoaching = 30;
        const sogliaIndiv    = 15;
        const sogliaTotPsico = 150;
        const totPsico       = singolo + gruppo;
        const barTot         = sogliaIPPB + sogliaCoaching + sogliaTotPsico;

        // Progress bar segments
        const segm = [
          { val: Math.min(ippb, sogliaIPPB), color: '#33c57d', label: t.supervisionBar.ippb },
          { val: Math.min(coaching, sogliaCoaching), color: '#ffe066', label: t.supervisionBar.coaching },
          { val: Math.min(gruppo, sogliaTotPsico - sogliaIndiv), color: '#374975', label: t.supervisionBar.group },
          { val: Math.min(singolo, sogliaTotPsico), color: '#6cc6f9', label: t.supervisionBar.ind },
          { val: Math.max(0, barTot - (Math.min(ippb, sogliaIPPB) + Math.min(coaching, sogliaCoaching) + Math.min(totPsico, sogliaTotPsico))), color: '#ccc', label: t.supervisionBar.missing }
        ];

        html3 += `<div class="stacked-bar-container" style="margin-bottom:10px;display:flex;width:100%;height:22px;border-radius:9px;overflow:hidden">`;
        segm.forEach(s => {
          html3 += `<div class="stacked-bar-segment" style="width:${(s.val/barTot*100).toFixed(1)}%;background:${s.color}" title="${s.label}: ${s.val}"></div>`;
        });
        html3 += `</div><div style="margin-bottom:12px;">`;
        segm.forEach(s => {
          if (s.val > 0 && s.label !== t.supervisionBar.missing) {
            html3 += `<span style="display:inline-block;margin-right:7px;background:${s.color};padding:2px 9px;border-radius:7px;color:white;font-size:0.99em">${s.label}</span>`;
          }
        });
        html3 += `</div><h3 style="color:coral;margin-top:18px;">${t.supervisionComments}</h3>`;
        const totale = ippb + coaching + singolo + gruppo;
        html3 += `<p style="margin-bottom:8px;"><strong>${t.supervisionValid(totale)}</strong></p>`;

        // Use only the 'mancanze' variable declared above
        if (ippb < sogliaIPPB) mancanze.push(t.supervisionMissingIPPB(sogliaIPPB - ippb));
        if (coaching < sogliaCoaching) mancanze.push(t.supervisionMissingCoaching(sogliaCoaching - coaching));
        if (totPsico < sogliaTotPsico) mancanze.push(t.supervisionMissingTotPsico(sogliaTotPsico - totPsico));
        if (singolo < sogliaIndiv) mancanze.push(t.supervisionMissingIndiv(sogliaIndiv - singolo));

        if (mancanze.length) {
          html3 += `<ul>${mancanze.map(m => `<li>${m}</li>`).join('')}</ul>`;
        } else {
          html3 += `<p style="color:green"><b>${t.supervisionNoMissing}</b></p>`;
        }

        output.innerHTML = `<div class="section">${html3}</div>`;
      }



      renderPeriods();
      [
        'creditiTeorici',
        'creditiPsy',
        'creditiCong',
        'supIPPB',
        'supWeiter',
        'supSingolo',
        'supGruppo'
      ].forEach(id => {
        const input = document.getElementById(id);
        const errorSpan = input.nextElementSibling;
        input.oninput = function() {
          let v = parseInt(input.value, 10);
          if (isNaN(v) || v < 0 || v > 500) {
            errorSpan.textContent = 'Value must be between 0 and 500';
            errorSpan.style.display = 'block';
            input.classList.add('error');
          } else {
            errorSpan.textContent = '';
            errorSpan.style.display = 'none';
            input.classList.remove('error');
          }
        };
      });

        function validatePeriodi() {
            let errore = false;
            document.querySelectorAll('.periodo').forEach((div, idx) => {
                const p = periodsData[idx];
                if (
                !p.tipoAttivita ||
                (p.tipoAttivita === "adult" && !p.categoria) ||
                !p.mesi ||
                (!p.pensum && p.pensum !== 0)
                ) {
                div.classList.add('errore-periodo');
                errore = true;
                } else {
                div.classList.remove('errore-periodo');
                }
            });
            return errore;
        }

        function validateCrediti() {
            let errore = false;
            // Validate only if the section is visible
            const section = document.getElementById('creditSectionTeorici');
            if (section && isVisible(section)) {
                ['partecipazioneSSPP','introProgram'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.selectedIndex === 0) {
                    el.classList.add('errore-select');
                    errore = true;
                } else if (el) {
                    el.classList.remove('errore-select');
                }
                });
                const program = document.getElementById('introProgram').value;
                if (program === '2024') {
                    const intro = document.getElementById('creditiCorso2024');
                    const val = parseInt(intro.value,10);
                    if (!val || val < 1 || val > 50) {
                        intro.classList.add('error');
                        errore = true;
                    } else {
                        intro.classList.remove('error');
                    }
                } else {
                    document.getElementById('creditiCorso2024').classList.remove('error');
                }
            }
            return errore;
        }

        // Check that gerontopsychiatry and center change questions are answered
        function validateGerontoCambio() {
            let errore = false;
            ['gerontoPsy', 'cambioCentro'].forEach(id => {
                const el = document.getElementById(id);
                if (el && isVisible(el)) {
                    if (el.selectedIndex === 0) {
                        el.classList.add('errore-select');
                        errore = true;
                    } else {
                        el.classList.remove('errore-select');
                    }
                }
            });
            return errore;
        }

        function validateSupervisioni() {
            let errore = false;
            const ids = ['supChange', 'supHrsChange'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el && isVisible(el)) {
                if (el.selectedIndex === 0) {
                    el.classList.add('errore-select');
                    errore = true;
                } else {
                    el.classList.remove('errore-select');
                }
                }
            });
            return errore;
        }

        function validateAll() {
            let errPeriodi = validatePeriodi();
            let errGeronto = validateGerontoCambio();
            let errCrediti = validateCrediti();
            let errSupervisioni = validateSupervisioni();
            return !(errPeriodi || errGeronto || errCrediti || errSupervisioni);
        }


      document.getElementById('calcBtn').onclick = updateResultsUI;
      
        function updateResultsUI() {
        calculateResult();      // Work periods
        calcolaCrediti();       // Credits
        calcolaSupervisioni();  // Supervisions
        // Always validate all sections
        const errorePeriodi = validatePeriodi();
        const erroreCrediti = validateCrediti();
        const erroreSupervisioni = validateSupervisioni();

        // Show header and PDF only if at least one section is valid without errors
        const showHeader = (
            (!errorePeriodi && document.getElementById('risultato').innerHTML.trim() !== '') ||
            (!erroreCrediti && document.getElementById('creditiOutput').innerHTML.trim() !== '') ||
            (!erroreSupervisioni && document.getElementById('supervisionOutput').innerHTML.trim() !== '')
        );
        document.getElementById('resultHeader').style.display = showHeader ? 'block' : 'none';
        document.getElementById('pdfButton').style.display = showHeader ? 'inline-block' : 'none';
        }

      
        document.getElementById('introProgram').addEventListener('change', e => {
          const val = e.target.value;
          document.getElementById('intro2024Fields').style.display = val === '2024' ? 'block' : 'none';
          document.getElementById('intro2009Fields').style.display = val === '2009' ? 'block' : 'none';
          if (val === '2024') {
            ['corsoCog','corsoPsy','corsoSis'].forEach(id => document.getElementById(id).checked = false);
          } else if (val === '2009') {
            document.getElementById('creditiCorso2024').value = '';
          }
        });

        document.getElementById('languageSwitcher').addEventListener('change', e => {
        const lang = e.target.value;
        localStorage.setItem('selectedLanguage', lang);
        updateLanguage(lang);
        document.getElementById('languageSwitcher').value = lang;
      });

      const savedLang = localStorage.getItem('selectedLanguage') || 'de';
      updateLanguage(savedLang);
      document.getElementById('languageSwitcher').value = savedLang;


      async function printPDF() {
        updateResultsUI();

        document.getElementById('pdfTitle').textContent =
        document.getElementById('headerTitle').textContent;
        document.getElementById('pdfSubtitle').textContent =
        document.getElementById('headerSubtitle').textContent;

        const dest1 = document.getElementById('pdfRisultato1');
        const dest2 = document.getElementById('pdfRisultato2');
        const dest3 = document.getElementById('pdfRisultato3');

        dest1.innerHTML = document.getElementById('risultato').innerHTML || '';
        dest2.innerHTML = document.getElementById('creditiOutput').innerHTML || '';
        dest3.innerHTML = document.getElementById('supervisionOutput').innerHTML || '';

        const pdfBox = document.getElementById('pdfExportBox');
        pdfBox.classList.remove('offscreen');
        pdfBox.style.display = 'block';
        pdfBox.style.position = 'relative';
        pdfBox.style.left = '0';

        if (document.fonts && document.fonts.ready) {
          await document.fonts.ready;
        }

        await new Promise(req => requestAnimationFrame(() => req()));

        const canvas = await html2canvas(pdfBox, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          scrollX: 0,
          scrollY: 0,
          windowWidth: pdfBox.scrollWidth,
          windowHeight: pdfBox.scrollHeight,
          logging: true
        });

        // DEBUG ‚îÄ append canvas preview; comment out later if desired
        // document.body.appendChild(canvas);

        // 7. Add captured image to jsPDF
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdf = new jspdf.jsPDF({
          unit: 'pt',
          format: 'a4',
          orientation: 'portrait'
        });

        const pageWidth  = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Compute scale so we fit width
        const imgWidth  = pageWidth;
        const imgHeight = canvas.height * (pageWidth / canvas.width);

        let posY = 0;
        let remainingHeight = imgHeight;

        // Add pages as needed
        let page = 0;
        while (remainingHeight > 0) {
          if (page > 0) pdf.addPage();
          pdf.addImage(
            imgData,
            'JPEG',
            0,
            posY ? -(posY) : 0,
            imgWidth,
            imgHeight
          );
          remainingHeight -= pageHeight;
          posY += pageHeight;
          page++;
        }

        pdf.save('Training_progress_report_GAP_SVPA-ASMAP-ASAP.pdf');

        pdfBox.classList.add('offscreen');
        pdfBox.style.display = 'none';
      }

      document.getElementById('pdfButton').onclick = printPDF;

      renderPeriods();
      });

    </script>

    <footer style="text-align:center; font-size:0.85em; color:#555; padding:20px; margin-top:40px;">
      <p>
        The code was created and licensed to the association by Dr. Davide Zani. For feedback or permission requests, 
        contact <a href="mailto:info@svpa-asmap.ch">info@svpa-asmap.ch</a>. 
        Reuse, redistribution, commercial use, or modification is not permitted without express authorization. 
        <br><br> ¬© 2025
        <a href="https://svpa-asmap.ch" target="_blank" rel="noopener noreferrer">SVPA-ASMAP-ASAP</a>
        <br>This educational tool is protected by Swiss copyright law (Art. 2 URG, SR 231.1). Licensed under 
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener noreferrer">
          Creative Commons BY-NC-ND 4.0
        </a>.
      </p>
      
      <p>
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener noreferrer">
          <img src="https://licensebuttons.net/l/by-nc-nd/4.0/88x31.png" alt="CC BY-NC-ND 4.0" style="border:none;">
        </a>
      </p>

    </footer>
    
    
    <div id="pdfExportBox" class="offscreen">
      <h1 id="pdfTitle" style="text-align: center; color:#352682; font-size: 2.3em; font-weight: bold; margin-bottom: 12px; font-family: Montserrat,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;"></h1>
      <h2 id="pdfSubtitle" style="text-align: center; color:#352682; font-size: 1.22em; font-weight: 500; margin-bottom: 32px; font-family: Montserrat,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;"></h2>
      <div id="pdfRisultato1" style="margin-bottom:34px"></div>
      <div id="pdfRisultato2" style="margin-bottom:28px"></div>
      <div id="pdfRisultato3" style="margin-bottom:28px"></div>
    </div>







  </body>
</html>
